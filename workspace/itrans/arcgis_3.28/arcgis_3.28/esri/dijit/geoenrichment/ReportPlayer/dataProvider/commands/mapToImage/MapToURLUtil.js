// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/commands/mapToImage/MapToURLUtil","dojo/_base/declare esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all dojo/dom-style esri/tasks/PrintTask esri/tasks/PrintParameters esri/tasks/PrintTemplate esri/layers/GraphicsLayer esri/dijit/geoenrichment/utils/UrlUtil esri/dijit/geoenrichment/utils/ImageInfoUtil ./DotDensityToImageUtil ./LegendToLayerUtil".split(" "),function(n,p,g,q,h,r,t,u,v,w,x,k,
y){var l,z=n(r,{_getPrintDefinition:function(a,b){var c=this.inherited(arguments);console.log(c);return c},_createOperationalLayers:function(a,b){var c=this.inherited(arguments);if(b.__legendLayerId){var d=c.filter(function(a){return a.id===b.__legendLayerId})[0];c.splice(c.indexOf(d),1);c.push(d)}return c}}),e={_createGraphicsLayerFromDotDensityLayer:function(a,b,c){return k.createPictureMarkersFromDotDensityLayer(b,c.extent,c).then(function(d){if(!d)return null;var e=new v;d.map(function(a){e.add(a)});
c.addLayer(e,a);b.visible=!1;return{addedLayer:e,hiddenLayer:b}}).otherwise(function(a){console.log(a);return null})},_replaceDotDensityLayersWithPictureMarkers:function(a){var b=[];for(i=0;i<a.graphicsLayerIds.length;i++)layer=a.getLayer(a.graphicsLayerIds[i]),layer.loaded&&layer.visible&&k.isDotDensity(layer)&&b.push(e._createGraphicsLayerFromDotDensityLayer(i,layer,a));return q(b)},_rollbackReplacing:function(a,b){b.forEach(function(c){c&&c.addedLayer&&a.removeLayer(c.addedLayer);c&&c.hiddenLayer&&
(c.hiddenLayer.visible=!0)})},setPrintMapTaskUrl:function(a){l=a;w.registerCORS(a)},mapToURL:function(a,b,c){var d=e._getUrlForMap(a);if(d)return d;d=e._replaceDotDensityLayersWithPictureMarkers(a).then(function(d){return g(b&&y.legendToGraphicsLayer(b,a,c),function(b){b&&a.addLayer(b);return g(e._runPrintTask(a,c,b),function(c){b&&a.removeLayer(b);e._rollbackReplacing(a,d);var m=new p;setTimeout(function(){m.resolve(c.url)},100);return m.promise})})});e._putUrlToCache(a,d);return d},_runPrintTask:function(a,
b,c){function d(){var d=new z(l),e=new t;e.map=a;var f=new u;f.exportOptions={width:3.125*h.get(b,"width"),height:3.125*h.get(b,"height"),dpi:300};f.format="png32";f.showAttribution=!1;f.__legendLayerId=c&&c.id;e.template=f;return d.execute(e)}return g(d(),function(a){return a},function(a){console.log(a);return g(d(),function(a){return a},function(a){console.log(a);return d()})})},urlToSrc:function(a,b){return b.saveImagesAsDataUrl?x.getRemoteImageDataUrl(a,{sizeLimit:1500}):a}},f,A=0;e.enableCaching=
function(){f={}};e.clearCaching=function(){f=null};e._putUrlToCache=function(a,b){f&&b&&(a.__mapToImageUtilKey=A++,f[a.__mapToImageUtilKey]=b)};e._getUrlForMap=function(a){return f&&f[a.__mapToImageUtilKey]};return e});