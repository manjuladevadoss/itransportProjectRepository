// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/CustomReportsManager","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when ./PortalManager ./ReportTemplateData ./StandardGraphicReportTemplates esri/dijit/geoenrichment/utils/PortalUtil esri/dijit/geoenrichment/utils/PortalQueryUtil esri/dijit/geoenrichment/utils/UrlUtil ../../config".split(" "),function(e,h,l,f,k,m,n,p,q,r,t){var u=e(null,{cache:null,constructor:function(){this.cache=
{}}});e={TEMPLATE_TYPE:"Report Template",PLAYER_STANDARD_INFOGRAPHIC_TYPEKEYWORD:"esriReportPlayerStandardInfographic",_reportsCache:null,resetCache:function(){this._reportsCache=new u},getCustomReports:function(a){var c=this;return f(k.getPortalInfo(a.portalUrl),function(b){var d=b.user.username,d={q:q.combineQueryString({type:"Report Template",typeKeywords:a.typeKeywords,owner:!a.publicOnly&&d}),sortField:"modified",sortOrder:"desc"};return p.queryCommon(r.combine(a.portalUrl,"sharing/rest/search"),
d).then(function(d){d=d.map(function(a){return c._prepareCustomReportFromItem(a,b.portal)});return c._getCountryReports(d,a.countryID)})})},_getCountryReports:function(a,c){return a&&a.filter(function(a){return!a.countries||a.countries.split(",").some(function(a){return c===a.trim()})})},_prepareCustomReportFromItem:function(a,c){var b=h.mixin({},a.properties||a.details);b.isGraphicReport="true"===b.isGraphicReport;b.isMultiFeature="true"===b.isMultiFeature;b.reportID=a.id;a={title:a.title,templateData:new m(a,
c.url),modified:a.modified instanceof Date?a.modified.getTime():a.modified};h.mixin(a,b);return a},getCustomReportByID:function(a){var c=this,b=this._reportsCache.cache[a.reportID];return b?b:this._reportsCache.cache[a.reportID]=f(k.getPortalInfo(a.portalUrl),function(b){return b.user.getItem(a.reportID).then(function(a){return a&&c._prepareCustomReportFromItem(a,b.portal)})}).otherwise(function(b){delete c._reportsCache.cache[a.reportID];return a.ignoreError?null:(new l).reject(b)})},tryFindReportIdByAlias:function(a){var c=
this,b=n.aliasToID(a.countryID,a.reportID);return b?f(this.getCustomReportByID({reportID:b,portalUrl:a.portalUrl,ignoreError:!0}),function(b){return b?b.reportID:f(c.getCustomReports({portalUrl:a.portalUrl,countryID:a.countryID,typeKeywords:"esriReportPlayerStandardInfographic",publicOnly:!0},!0),function(b){function c(a){a=a.split(".");return Number((Number(a[0])+Number(a[1])/100).toFixed(2))}var d=c(t.jsapiVersion),e,f=-Infinity;b.forEach(function(b){if(b.playerAlias===a.reportID){var g=c(b.jsapiVersion);
d>=g&&g>f&&(f=g,e=b)}});return e&&e.reportID})}):null},itemUpdated:function(a){delete this._reportsCache.cache[a]},getFakeCustomReportByContext:function(a){return{title:"Generic template",type:"esriReportTemplateStandard",coverage:a.countryID,countries:a.countryID,hierarchy:a.hierarchy||"census",isGraphicReport:!0,isMultiFeature:!1,reportID:null}}};e.resetCache();return e});