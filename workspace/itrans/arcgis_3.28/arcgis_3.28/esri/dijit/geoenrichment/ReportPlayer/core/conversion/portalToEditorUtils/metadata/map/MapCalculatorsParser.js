// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/conversion/portalToEditorUtils/metadata/map/MapCalculatorsParser",["esri/dijit/geoenrichment/utils/JsonXmlConverter","./MetadataToRendererParser","esri/dijit/geoenrichment/utils/ImageUtil"],function(c,n,p){var l={};MapTagsUtil={tagToColor:function(b){if(!b)return null;b=b.attributes;return[Number(b.Red),Number(b.Green),Number(b.Blue),void 0===b.Transparency?255:255*(1-Number(b.Transparency)/100)]}};l.parseMapCalculators=function(b,m,l){c.queryJson(b,
"Maps").forEach(function(b){c.queryJson(b,"Map").forEach(function(h){var a=c.queryJson(h,/^(|Layer|LocatorResultsLayer|ComparisonResultsLayer)$/),g=a.filter(function(a){return!!a.attributes.PortalItemId}),a=a.filter(function(a){return!!a.attributes.ServiceUrl||"LocatorResultsLayer"===a.name||"ComparisonResultsLayer"===a.name}),k;1<g.length&&(k=g.shift());var g=g.shift(),e=[];a.forEach(function(a){if(a.attributes.ServiceUrl)e.push({url:a.attributes.ServiceUrl});else if("LocatorResultsLayer"===a.name){var b=
a.tags&&a.tags.filter(function(a){return"Renderer"===a.name})[0],c=m.metadata.locatorCalculatorsHash[a.attributes.CalculatorName];c.isValid&&e.push({isLocatorLayer:!0,layerName:a.attributes.LayerName,calculatorName:a.attributes.CalculatorName,calculatorInfo:c,rendererJson:b&&n.parseRendererJson(b)})}else"ComparisonResultsLayer"===a.name&&((b=(b=a.tags&&a.tags.filter(function(a){return"Renderer"===a.name})[0])&&n.parseRendererJson(b))&&"esriTS"===b.uniqueValueInfos[0].symbol.type?e[e.length-1].labelRendererJson=
b:e.push({isComparisonLayer:!0,calculatorName:a.attributes.CalculatorName,rendererJson:b,labelRendererJson:null}))});var f;if(a=c.queryJson(h,"SiteLayer")[0])if((a=c.queryJson(a,"Symbol")[0])&&"Image"===a.attributes.Type){var d=l.getImageData(a.attributes.Name);d&&(f={type:"esriPMS",contentType:p.getContentType(d),imageData:p.base64DataFromDataURL(d),url:a.attributes.Url,width:Number(a.attributes.Width),height:Number(a.attributes.Height),angle:Number(a.attributes.Angle)||0,xoffset:Number(a.attributes.XOffset)||
0,yoffset:Number(a.attributes.YOffset)||0})}else if(a&&"Marker"===a.attributes.Type){f=c.queryJson(a,"Fill")[0];f=c.queryJson(f,"Color")[0];var d=c.queryJson(a,"Outline")[0],q=c.queryJson(d,"Color")[0];f={type:"esriSMS",style:"esriSMS"+(a.attributes.Style||"Circle"),size:Number(a.attributes.Size),angle:Number(a.attributes.Angle)||0,xoffset:Number(a.attributes.XOffset)||0,yoffset:Number(a.attributes.YOffset)||0,color:MapTagsUtil.tagToColor(f),outline:d&&{type:"esriSLS",color:MapTagsUtil.tagToColor(q),
style:"esriSLS"+(d.attributes.Style||"Solid"),width:void 0===d.attributes.Width?1:Number(d.attributes.Width)}}}k={fieldName:h.attributes.Name,defaultBasemapId:k&&k.attributes.PortalItemId,webMapId:g&&g.attributes.PortalItemId,additionalLayerInfos:e.length&&e,pinSymbolJson:f,mapScale:Number(h.attributes.Scale)||null};m&&(m.metadata.mapImageInfosHash[b.attributes.Name+"."+h.attributes.Name]=k)})})};return l});